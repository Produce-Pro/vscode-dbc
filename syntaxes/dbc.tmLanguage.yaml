---
name: dbc
scopeName: source.dbc
version: '0.0.1'
patterns:
- match: "^\\s+(INC)\\s*(.*)"
  name: meta.import.dbc
  captures:
    '1':
      name: keyword.other.dbc
    '2':
      name: storage.modifier.import.dbc
- include: "#code"
repository:
  code:
    patterns:
    - include: "#strings"
    - include: "#keywords"
    - include: "#functions"
    - include: "#expressions"
    - include: "#all-types"
    - include: "#comments"
  strings:
    patterns:
    - begin: "\""
      beginCaptures:
        '0':
          name: punctuation.definition.string.begin.dbc
      end: "\""
      endCaptures:
        '0':
          name: punctuation.definition.string.end.dbc
      name: string.quoted.double.dbc
      patterns:
      - match: "#."
        name: constant.character.escape.dbc
  keywords:
    patterns:
    - name: keyword.control.dbc
      match: "^\\s+(LOOP|WHILE|DO|FOR|REPEAT|CONTINUE|BREAK|UNTIL)\\b"
    - name: keyword.control.dbc
      match: "^\\s+(RETURN|CHAIN|STOP|BEEP)\\s+"
    - name: support.function.dbc
      match: "^\\s+([A-Z]\\.)?(QUERY\\.[A-Z0-9]{1,3}[1-9]{1,2})(?!\\w|\\.|\\$|=)"
    - name: support.function.dbc
      match: "^\\s+(CALL)\\s([A-Z]\\.)?((NEXT|BACK)\\.[A-Z0-9]{1,3}[1-9]{1,2})(?!\\w|\\.|\\$|=)"
      captures:
        '1':
          name: keyword.control.dbc
    - name: support.function.dbc
      match: "^\\s+(CALL)\\s([A-Z]\\.)?((BK|PT|WT|RD|RT|OD|OP|RK|CO|CL|PR|UK|RP)[A-Z0-9]{1,3}[1-9]{0,2})(?!\\w|\\.|\\$|=)"
      captures:
        '1':
          name: keyword.control.dbc
        '2':
          name: support.function.dbc
    - match: "^\\s+(GOTO|CALL|PERFORM|BRANCH)\\s+([A-Z0-9._$@]+(?!\\w|\\.|\\$|=))"
      captures:
        '1':
          name: keyword.control.dbc
        '2':
          name: entity.name.function.dbc
    - name: keyword.control.dbc
      match: "^\\s+(ENDSWITCH|CASE|DEFAULT)\\s+"
    - name: keyword.control.dbc
      match: "^\\s+(IF|ENDIF|ELSE)(?!\\w|\\.|\\$|=)"
    - name: keyword.control.dbc
      match: "(?<!\\w|\\.|\\$)(IF|ENDIF|ELSE)(?!\\w|\\.|\\$|=)"
    - name: keyword.operator.arithmetic.dbc
      match: "(?<!^)(\\-|\\+|\\*|\\/|%)"
    - name: constant.numeric.dbc
      match: "\\b[0-9]*(\\.[0-9]+)*\\b"
    - name: constant.numeric.dbc
      match: "\\s(@)$"
    - name: keyword.operator.logical.dbc
      match: "(?<!\\w|\\.|\\$)(AND|OR|NOT)(?!\\w|\\.|\\$|=)"
    - name: entity.name.function.dbc
      match: "([A-Z0-9._$@]+(?!\\w|\\.|\\$|=))\\s+(ROUTINE|LROUTINE|VERB)(?!\\w|\\.|\\$|=)\\s([A-Z0-9._$@]+(?!\\w|\\.|\\$|=|,))*"
      captures:
        '1':
          name: entity.name.function.dbc
        '2':
          name: entity.name.function.dbc
        '3':
          name: variable.parameter.dbc
    - name: entity.name.function.dbc
      match: "^\\s(ENDROUTINE)(?!\\w|\\.|\\$|=)"
    - name: keyword.operator.comparison.dbc
      match: "(=|!=|<=|>=|<>|<|>)"
    - name: meta.arrayindex.meta
      match: "(\\[|\\])"
    - name: keyword.operator.assignment.dbc
      begin: "(?!\\w|\\.|\\$|=)\\s(FROM|WITH|OF|IN)\\s"
      beginCaptures:
        '1':
          name: keyword.ssraw
        '3':
          name: constant.numeric.ssraw
      patterns:
      - include: "$self"
      - name: keyword.operator.assignment.dbc
        match: ","
      - name: variable.parameter.dbc
        match: "([A-Z0-9._$@]+)"
      end: "\\n"
    - name: keyword.operator.assignment.dbc
      match: "(?!\\w|\\.|\\$|=)\\s(TO|INTO)\\s"
    - name: entity.name.function.dbc
      match: "^([A-Z0-9_$@]+[A-Z0-9._$@]*(?!\\w|\\.|\\$|=))$"
  comments:
    patterns:
    - match: "^([\\.\\*\\+]).*"
      name: comment.line.dbc
    - match: "\\s+(\\.).*"
      name: comment.line.empty.dbc
  
  all-types:
    patterns:
    - include: "#primative-types"
    - include: "#flags"
    - include: "#verb-types"
  flags:
    patterns:
    - match: "(?<!\\w|\\.|\\$)(EOS|OVER|EQUAL|LESS|NULL)(?!\\w|\\.|\\$|=)"
      name: storage.type.flags.dbc
    - match: "\\s+(DEBUG)\\s+"
      name: storage.type.flags.dbc
  expressions:
    patterns:
    - begin: "\\("
      beginCaptures:
        '0':
          name: keyword.operator.dbc
      end: "\\)"
      endCaptures:
        '0':
          name: keyword.operator.dbc
      name: keyword.operator.dbc
      patterns:
      - include: "$self"
      - include: "#strings"
      - include: "#dbc-functions"
      - include: "#all-types"
      - include: "#keywords"
      - match: "([A-Z0-9._$@]+)"
        name: variable.parameter.dbc
  verb-types:
    patterns:
    - match: "(?<!\\w|\\.|\\$)(CVARLIT|NVARLIT|CVAR|NVAR|CNVARLIT|CNVAR|ANY|VAR|VARLIT)\\b(\\s|,|:)"
      captures:
        '1':
          name: storage.type.verb.dbc
    - match: "(?<!\\w|\\.|\\$)(LABEL|ARRAY|QUEUE|OBJECT)(?!\\w|\\.|\\$|=)"
      captures:
        '1':
          name: storage.type.verb.dbc
    - match: "(?<!\\w|\\.|\\$)(CARRAY|NVARRAY|NARRAY)[1-3](?!\\w|\\.|\\$|=)"
      captures:
        '1':
          name: storage.type.verb.dbc
  primative-types:
    patterns:
    - match: "\\s(?:CHAR|FORM|EXTERNAL|EQU)\\b"
      name: storage.type.primative.dbc
    - match: "\\s(LABEL|ARRAY|QUEUE|OBJECT)\\s"
      name: storage.type.primative.dbc
    - match: "\\s(AFILE|IMAGE|FILE|IFILE|PFILE|DEVICE|RESOURCE|LIST)\\s"
      name: storage.type.primative.dbc
    - match: "\\s(GCHAR|GFORM)\\s"
      name: storage.type.primative.dbc
  dbc-functions:
    patterns:
    - name: constant.other.dbc
      match: "\\b(CHOP|SQUEEZE|TRIM|MOD)\\s+"
    - match: "^\\s+(SWITCH|MOVE|FILL|APPEND|CMOVE|MOVEFPTR|MOVELPTR|BUMP|LENSET|REPLACE|REP|SETLPTR|SETFPTR|ADD|SUB|MULT|DIVIDE|SEARCH|SCAN|MATCH|TYPE|FLAGREST|ENDSET|PAUSE|TRAPCLR|TRAPSET|TRAPREST|NORETURN|SHUTDOWN|CLOCK|RETCOUNT|TESTADR|MOVEADR|MOVEVL|TESTLABEL|MOVELABEL|CLOSE|PREP|READ|OPEN|ERASE|ROLLOUT|REPOSIT|LOADMOD|UNLOAD|PRINT|UPDATE|FPOSIT|UNPACK)\\s+([A-Z0-9._$@]+(?!\\w|\\.|\\$|=))?"
      captures:
        '1':
          name: keyword.operator.dbc
        '2':
          name: variable.parameter.dbc
    - name: keyword.operator.dbc
      match: "^\\s+(SETFLAG|DISPLAY|SCRNSAVE|SCRNREST|DSPFNC|STATESAVE|STATEREST|PACK|LOAD|PACKLEN|STORE|CLEAR|SET|RESET|FLAGSAVE|CLEARADR|TRAPSAVE|TRAP|CLEARLABEL|GETPARM|SETVAR|SETVAR\\.YN|WRITE|SETNVAR|SETCVAR)\\s+"
    - name: constant.other.dbc
      match: "^\\s+#(IFDEF|IFNDEF|ENDIF|IFLABEL|IFNLABEL)(?!\\w|\\.|\\$|=)"
    - name: support.function.dbc
      match: "^\\s+(TSTAMP|DATE|TIME|ELAPSED|MESSAGE)\\b"
    - name: support.function.dbc
      match: "^\\s+(LMOD|ULMOD)\\s+"
    - name: support.function.dbc
      match: "^\\s+(NOBLANK|NOZERO)\\s+"
    - name: support.function.dbc
      match: "^\\s+(RETURN.EOS|RETURN.NOTEOS)\\s+"
    - name: entity.name.function.dbc
      match: "^\\s+([A-Z0-9._$@]+(?!\\w|\\.|\\$|=))\\s+"
  functions:
    patterns:
    - include: "#dbc-functions"
